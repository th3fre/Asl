<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASL Tunnel - Universal Master Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --app-green: #2d5a3f; --app-light-green: #4caf50; --bg-dark: #0a0a0a; --card-bg: #1c2128; --border: #30363d; --error: #ff5252; --blue: #2196f3; }
        body { margin: 0; padding: 0; background-color: var(--bg-dark); color: white; font-family: 'Cairo', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .app-bar { background-color: var(--app-green); padding: 15px; text-align: center; font-weight: bold; font-size: 1.2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; flex: 1; }
        .main-card { background-color: var(--card-bg); border-radius: 20px; padding: 25px; border: 1px solid var(--border); }
        textarea { width: 100%; height: 180px; padding: 15px; box-sizing: border-box; border-radius: 12px; border: 1px solid var(--border); background: #0d1117; color: #4caf50; font-family: monospace; outline: none; margin-bottom: 15px; resize: none; font-size: 0.85rem; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn { border: none; padding: 15px; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; flex: 1; font-family: 'Cairo'; }
        .btn-convert { background: linear-gradient(180deg, #4caf50, #2e7d32); color: white; }
        .btn-clear { background: #333; color: white; }
        .result-box { margin-top: 20px; display: none; background: #0d1117; padding: 15px; border-radius: 12px; border: 1px solid var(--app-light-green); text-align: left; animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .uri-text { word-break: break-all; font-family: monospace; font-size: 0.8rem; color: #4caf50; background: rgba(0,0,0,0.5); padding: 12px; border-radius: 8px; display: block; margin: 10px 0; border: 1px solid #222; line-height: 1.6; }
        .footer-btns { display: flex; gap: 8px; margin-top: 10px; }
        .copy-btn { flex: 2; background: var(--app-green); color: white; padding: 12px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }
        .check-btn { flex: 1; background: var(--blue); color: white; padding: 12px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }
        .badge { background: #1c2128; color: var(--app-light-green); padding: 5px 12px; border-radius: 8px; font-size: 0.75rem; border: 1px solid var(--app-light-green); }
        #status { font-weight: bold; font-size: 0.85rem; }
        footer { background-color: #161b22; padding: 20px; text-align: center; border-top: 1px solid var(--border); margin-top: 40px; }
        .footer-text { font-size: 0.9rem; color: #8b949e; margin-bottom: 10px; }
        .footer-links { display: flex; justify-content: center; gap: 20px; font-size: 0.8rem; }
        .footer-links a { color: var(--app-light-green); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <div class="app-bar">ASL TUNNEL -  V2Tool</div>

    <div class="container">
        <div class="main-card">
            <h3 style="margin-top:0; text-align: center;">تحويل JSON أو فحص رابط URI</h3>
            <textarea id="input" placeholder="الصق كود JSON أو رابط vmess/vless/trojan مباشرة..."></textarea>
            
            <div class="btn-group">
                <button class="btn btn-convert" onclick="process()">تحويل / فحص</button>
                <button class="btn btn-clear" onclick="clearBox()">إفراغ</button>
            </div>

            <div id="result" class="result-box">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="badge" id="protoBadge">READY</div>
                    <span id="status"></span>
                </div>
                <div class="uri-text" id="uriOutput"></div>
                <div class="footer-btns">
                    <button class="copy-btn" onclick="copyText()">نسخ الرابط</button>
                    <button class="check-btn" onclick="checkServer()">فحص السيرفر</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-text">تم التطوير بواسطة <b>ASL TUNNEL VPN</b> © 2026</div>
        <div class="footer-links">
            <a href="https://t.me/ASLTUNNEL">قناة التليجرام</a>
            <a href="https://asltunnel.com">الرئيسية</a>
        </div>
    </footer>

    <script>
        let currentHost = "";

        function clearBox() {
            document.getElementById('input').value = '';
            document.getElementById('result').style.display = 'none';
            currentHost = "";
        }

        function extractHostFromURI(uri) {
            try {
                if (uri.startsWith('vmess://')) {
                    const decoded = JSON.parse(atob(uri.split('vmess://')[1]));
                    return decoded.add;
                } else if (uri.startsWith('vless://') || uri.startsWith('trojan://')) {
                    // استخراج الـ host الذي يأتي بعد الـ @ وقبل الـ :
                    return uri.split('@')[1].split(':')[0];
                }
            } catch (e) { return ""; }
            return "";
        }

        function process() {
            let str = document.getElementById('input').value.trim();
            if(!str) return;

            // الحالة 1: إذا كان المدخل رابط URI مباشرة
            if (str.startsWith('vmess://') || str.startsWith('vless://') || str.startsWith('trojan://')) {
                currentHost = extractHostFromURI(str);
                document.getElementById('uriOutput').innerText = str;
                document.getElementById('protoBadge').innerText = str.split('://')[0].toUpperCase();
                document.getElementById('status').innerText = "";
                document.getElementById('result').style.display = 'block';
                return;
            }

            // الحالة 2: معالجة JSON
            try {
                str = str.replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/\u00A0/g, ' ');
                str = str.replace(/\\\/|\\/g, '/').replace(/\/+/g, '/').replace(':/', '://');
                str = str.replace(/\\"/g, '"');

                const json = JSON.parse(str);
                let ob = json.outbounds ? json.outbounds.find(o => ["vmess", "vless", "trojan"].includes(o.protocol)) : json;
                
                if(!ob) throw new Error();

                const proto = ob.protocol;
                const stream = ob.streamSettings || {};
                const ws = stream.wsSettings || {};
                const host = ws.headers?.Host || ws.headers?.host || "";
                const path = ws.path || "";
                
                let finalUri = "";

                if(proto === 'vmess') {
                    const vnext = ob.settings.vnext[0];
                    currentHost = vnext.address;
                    const vObj = {"v":"2","ps":"ASL_VMESS","add":vnext.address,"port":vnext.port,"id":vnext.users[0].id,"aid":"0","net":stream.network||"ws","host":host,"path":path,"tls":stream.security||""};
                    finalUri = "vmess://" + btoa(unescape(encodeURIComponent(JSON.stringify(vObj))));
                } 
                else if(proto === 'vless') {
                    const vnext = ob.settings.vnext[0];
                    currentHost = vnext.address;
                    finalUri = `vless://${vnext.users[0].id}@${vnext.address}:${vnext.port}?type=${stream.network}&security=${stream.security}&path=${encodeURIComponent(path)}&host=${host}#ASL_VLESS`;
                }
                else if(proto === 'trojan') {
                    const srv = ob.settings.servers[0];
                    currentHost = srv.address;
                    finalUri = `trojan://${srv.password}@${srv.address}:${srv.port}?peer=${host}&security=${stream.security || 'tls'}&path=${encodeURIComponent(path)}&type=${stream.network || 'ws'}#ASL_TROJAN`;
                }

                document.getElementById('uriOutput').innerText = finalUri;
                document.getElementById('protoBadge').innerText = proto.toUpperCase();
                document.getElementById('status').innerText = "";
                document.getElementById('result').style.display = 'block';

            } catch (e) {
                alert("بيانات غير صالحة!");
            }
        }

        async function checkServer() {
            if(!currentHost) { alert("لم يتم العثور على عنوان للسيرفر!"); return; }
            const statusIndicator = document.getElementById('status');
            statusIndicator.innerText = "جاري الفحص...⏳";
            statusIndicator.style.color = "orange";

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 6000);
                // محاولة الاتصال بعنوان السيرفر المستخرج
                await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('http://' + currentHost)}`, { mode: 'no-cors', signal: controller.signal });
                statusIndicator.innerText = "متصل ✅";
                statusIndicator.style.color = "#4caf50";
            } catch (e) {
                statusIndicator.innerText = "غير متصل ❌";
                statusIndicator.style.color = "#ff5252";
            }
        }

        function copyText() {
            const text = document.getElementById('uriOutput').innerText;
            navigator.clipboard.writeText(text);
            alert("تم النسخ!");
        }
    </script>
</body>
</html>